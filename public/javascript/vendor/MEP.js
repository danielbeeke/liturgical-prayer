var S=class{constructor(t){this.uri=t}async init(){}async execute(t){try{let r=t.command,n=this[r](t);t.meta.mepApi={url:n};let a=navigator.onLine?await fetch(n):null,o=navigator.onLine?await a.json():{};o.url=n;let e=o.data;return o.data=Array.isArray(e)?e.filter(i=>i):e,o}catch(r){console.log(r)}}findAll(t){var a,o;let r=new URLSearchParams,n="";if(((a=t.page)==null?void 0:a.limit)&&r.set("limit",t.page.limit.toString()),((o=t.page)==null?void 0:o.offset)&&r.set("offset",t.page.offset.toString()),t.filters)for(let[e,i]of Object.entries(t.filters)){Array.isArray(i)||(i=[i]);for(let l of i)e==="langCode"?n+=`&langCode=${l}`:n+=`&filter[${e}]=${l}`}if(t.sorts)for(let[e,i]of Object.entries(t.sorts))r.set(`sort[${e}]`,i);return t.search&&r.set("search",t.search),this.uri+"/"+t.type.join(",")+"?"+(r.toString()?"&"+r:"")+n}async cleanup(){}};var v;(function(r){r.readonly="readonly",r.readwrite="readwrite"})(v||(v={}));var E=s=>Object.assign({},s,{id:s.id.split(":")[0]});var D=s=>{if(!s)debugger;return s.substr(0,4)!=="http"?s:s.split(/\/|#/).pop()};function I(s){return(t,r)=>{for(let[n,a]of s.values()){let o=l=>typeof l=="string"?encodeURIComponent(l):Array.isArray(l)?l.map(f=>encodeURIComponent(f)).join(","):l,e=o(t[n]),i=o(r[n]);if(e>i)return a==="asc"?1:-1;if(e<i)return-(a==="asc"?1:-1)}return 0}}var x=function(s,t){return s?s.reduce(function(r,n){return(r[n[t]]=r[n[t]]||[]).push(n),r},{}):{}};var P=class{constructor(){this.stores={ebook:null,person:null,category:null,page:null,language:null,organization:null,keyword:null,url:null,info:null,video:null,prayer:null}}async init(t){return new Promise((r,n)=>{let a=()=>{this.openRequest=indexedDB.open("dataDB",9),this.openRequest.addEventListener("error",o=>{n(o)}),this.openRequest.addEventListener("success",o=>{this.database=o.target.result,r(!0)}),this.openRequest.addEventListener("upgradeneeded",o=>{this.database=o.target.result;let e=o.oldVersion,i=o.newVersion||this.database.version;for(let l of Object.keys(this.stores))this.database.objectStoreNames.contains(l)||this.database.createObjectStore(l,{keyPath:"id"})})};if(t){let o=indexedDB.deleteDatabase("dataDB");o.onerror=()=>console.log("Error deleting database."),o.onsuccess=()=>a()}else a()})}async execute(t){return await this[t.command](t)}async findAll(t){let r={command:"getAll"},n=[];for(let e of t.type){let i=await this.transaction(e,[r],v.readonly);n=[...n,...i.pop()]}let a=n.map(E);if(t.filters&&Object.keys(t.filters).length&&(a=a.filter(e=>{let i=!0;for(let[l,f]of Object.entries(t.filters))if(Array.isArray(f))if(Array.isArray(e[l]))e[l].some(p=>f.includes(D(p)))||(i=!1);else if(!e[l])i=!1;else{let p=D(e[l]);f.includes(p)||(i=!1)}else Array.isArray(e[l])?e[l].some(p=>D(p)===f)||(i=!1):e[l]!==f&&(i=!1);return i})),t.search&&(a=a.filter(e=>{var i,l;return((i=e==null?void 0:e.title)==null?void 0:i.toLowerCase().includes(t.search.toLowerCase()))||((l=e==null?void 0:e.searchWords)==null?void 0:l.join(" ").toLowerCase().includes(t.search.toLowerCase()))})),t.sorts&&Object.keys(t.sorts).length){let e=Object.entries(t.sorts).map(([i,l])=>[i,l]);a.sort(I(e))}let o=a.length;return t.page&&"offset"in t.page&&"limit"in t.page&&(a=a.splice(t.page.offset,t.page.limit)),{data:a,total:o}}async updateCache(t,r,n){var p,b,B,d,y;if(t.data===void 0)return;let a=Array.isArray(t.data)?t.data:[t.data],o=a.flatMap((c,u)=>{let h=r.find(A=>c.id===A.id&&c.langCode===A.langCode),g=Object.assign({},c);if(!c)return[];if(JSON.stringify(g)===JSON.stringify(h))return[];c&&c.langCode&&c.type!=="language"&&(g.id=c.id+":"+c.langCode);let w=[];return w.push({command:"delete",data:g.id,type:c.type}),w.push({command:"add",data:g,type:c.type}),w}),e=null,i;if((b=(p=n.meta)==null?void 0:p.mepApi)==null?void 0:b.url){e=(y=await this.transaction("url",[{command:"get",data:(d=(B=n.meta)==null?void 0:B.mepApi)==null?void 0:d.url}],v.readonly))!=null?y:{id:n.meta.mepApi.url,identifiers:[]},i=e.identifiers,e.identifiers=a.map(u=>u.type==="language"?u.id:u.id+":"+u.langCode);let c=r.map(u=>[u.type,u.type==="language"?u.id:u.id+":"+u.langCode]).filter(([u,h])=>!e.identifiers.includes(h));for(let[u,h]of c)o.push({command:"delete",data:h,type:u})}let l=[];e&&JSON.stringify(e.identifiers)!==JSON.stringify(i)&&l.push(this.transaction("url",[{command:"delete",data:e.id},{command:"add",data:e}]));let f=x(o,"type");for(let[c,u]of Object.entries(f))l.push(this.transaction(c,u));await Promise.all(l)}transaction(t,r,n=v.readwrite){let a=this.database.transaction(t,n),o=[];for(let e of r)a.objectStore(t)[e.command](e.data).addEventListener("success",l=>{var f;((f=l.target)==null?void 0:f.result)&&o.push(l.target.result)});return new Promise((e,i)=>{a.addEventListener("complete",l=>r.length===1&&r[0].command==="get"?e(o.pop()):e(o)),a.addEventListener("error",l=>console.warn(l))})}async cleanup(){await this.database.close(),console.log()}};var C=function(s){var t=0;if(s.length==0)return t;for(var r=0;r<s.length;r++){var n=s.charCodeAt(r);t=(t<<5)-t+n,t=t&t}return t};var O=new Map,R=class{constructor(t,r){this.filters={};this.sorts={};this.page={};this.langCode=null;this.chosenStrategy="default";this.textSearch="";this.api=t,this.type=Array.isArray(r)?r:[r]}sort(t={}){return this.sorts=t,this}filter(t={}){return this.filters=t,this}strategy(t){return this.chosenStrategy=t,this}paginate(t={limit:100,offset:0}){return this.page=t,this}search(t){return this.textSearch=t,this}groupBy(t){return this.groupKey=t,this}preferredLanguage(t){return this.langCode=t,this}execute(){let t={command:"findAll",type:this.type,filters:this.filters,sorts:this.sorts,page:this.page,langCode:this.langCode,groupBy:this.groupKey,search:this.textSearch,strategy:this.chosenStrategy,meta:{}},r=C(JSON.stringify(t));if(O.has(r))return O.get(r);let n=this.api.strategies[t.strategy].call(this.api,t,()=>O.delete(r));return O.set(r,n),n}async then(t){return t(await this.execute())}};var H=(s,t)=>{var n;return(n=s.find(a=>(a==null?void 0:a.langCode)===t))!=null?n:s[0]};var M=s=>typeof s=="object"&&!Array.isArray(s)&&(s==null?void 0:s.id),J=s=>Array.isArray(s)&&s.slice(0,5).every(t=>M(t)),L=s=>{let t=!0;return new Proxy(s,{get:function(r,n,a){return n==="then"&&t?(t=!1,null):Reflect.get(r,n,a)}})},m=(s,t,r=null)=>{let n=typeof s=="object"&&typeof(s==null?void 0:s.then)=="function",a=new Promise(f=>f(s)),o=n?()=>s:()=>a,e=!1,i={},l=new Proxy(o,{set:function(f,p,b){return p==="langCode"?(r=b,!0):(f=o(),Reflect.set(i,p,b))},get:function(f,p,b){if(f=o(),i==null?void 0:i[p])return i==null?void 0:i[p];if(p==="isProxy")return!0;if(p==="$")return f;if(p==="length")return(async()=>{let d=await f;return d==null?void 0:d.length})();if(p==="then")return d=>d(f);let B=(d,y,c)=>{var h;d=(h=d==null?void 0:d.data)!=null?h:d;let u=J(d)?H(d,r||c.langCode):d;if(u==null?void 0:u[y]){let g=u[y];if(typeof g=="string"&&g.includes(c.rdfBase)){let[,,,,w,A]=g.split("/"),j=m(c.query(w).strategy(e?"stale":"default").filter({id:A}),c,r);return e=!1,j}return m(g,c,r)}else if(Array.isArray(d)){let g=d.find(w=>{var j;let A=(j=w==null?void 0:w.url)!=null?j:w;return typeof A.includes=="function"&&A.includes(y)});return m(g,c,r)}};return p==="stale"?(e=!0,l):p==="map"?async d=>{let y=await f;if(Array.isArray(y)){let c=[];for(let h of y.values()){if(typeof h=="string"&&h.includes(t.rdfBase)){let[,,,,w,A]=h.split("/");h=await t.query(w).strategy(e?"stale":"default").filter({id:A})}let g=L(m(h,t,r));c.push(g)}return e=!1,(await Promise.all(c.map(d))).filter(h=>h)}}:p===Symbol.asyncIterator?async function*(){let d=await f;if(Array.isArray(d)){for(let y of d.values())if(typeof y=="string"&&y.includes(t.rdfBase)){let[,,,,c,u]=y.split("/"),h=await t.query(c).strategy(e?"stale":"default").filter({id:u});e=!1,yield L(m(h,t,r))}}}:m(o().then(d=>B(d,p,t)),t,r)}});return l};var k=new Map,N=async function(s,t=()=>null){let r=e=>(s.groupBy&&e&&(e.groupedData=[...Object.values(x(e.data,s.groupBy))].map(i=>m(i,this,s.langCode))),e),n=C(JSON.stringify(s));if(k.has(n))return r(k.get(n));let a=await this.getResults(s,"local"),o=e=>{k.set(n,e),t(),this.handlers.local.updateCache(e,a.data,s).then(()=>{this.dispatchEvent(new CustomEvent("update",{detail:{query:s,data:e}}))})};if((navigator==null?void 0:navigator.onLine)!==!1)if(a.total===0){let e=await this.getResults(s,"api");return o(e),r(e)}else this.getResults(s,"api").then(e=>o(e));return r(a)};var Q=new Map,U=async function(s,t=()=>null){let r=e=>(s.groupBy&&(e.groupedData=[...Object.values(x(e.data,s.groupBy))].map(i=>m(i,this,s.langCode))),e),n=C(JSON.stringify(s));if(Q.has(n))return r(Q.get(n));let a=await this.getResults(s,"local"),o=e=>{Q.set(n,e),this.handlers.local.updateCache(e,a.data,s),t()};if((navigator==null?void 0:navigator.onLine)!==!1&&a.total===0){let e=await this.getResults(s,"api");return o(e),r(e)}return r(a)};var F=class extends EventTarget{constructor(t){super();this._types=[];this.langCode="en";this.inMemory=new Map;this.cleanup=!1;Object.assign(this,{handlers:{api:new S(t.apiUrl),local:new P},strategies:{default:N,stale:U}},t),this.types.length||(this.types=["info"]),this.init()}async init(){let t=new CustomEvent("ready");if(await Promise.all(Object.values(this.handlers).map(r=>r.init(this.cleanup))),(await this.info()).data.length===0)throw new Error("Unknown channel id");this.types=(await this.info().types).all,this.dispatchEvent(t)}get types(){return this._types}set types(t){this._types=t;for(let r of this._types)this[r]=n=>{let a={};n&&(a.id=n);let o=this.query(r).filter(a).execute().then(e=>({data:e.data}));return m(o,this)}}query(t){return new R(this,t)}async getResults(t,r){let a=await this.handlers[r].execute(t);return{query:t,handler:r,...a}}wrap(t){return m(t,this)}};export{F as MEP};
